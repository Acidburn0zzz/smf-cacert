#!/bin/ksh
# 2016-12-02 (c) Olaf Bohlen <olbohlen@eenfach.de>
# this is a SMF service method to update root certificate copies
# for curl, openssl, etc.

# CDDL HEADER START

# The contents of this file are subject to the terms of the
# Common Development and Distribution License (the "License").
# You may not use this file except in compliance with the License.

# You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
# or http://www.illumos.org/license/CDDL.
# See the License for the specific language governing permissions
# and limitations under the License.

# When distributing Covered Code, include this CDDL HEADER in each
# file and include the License file at usr/src/OPENSOLARIS.LICENSE.
# If applicable, add the following below this CDDL HEADER, with the
# fields enclosed by brackets "[]" replaced with your own identifying
# information: Portions Copyright [yyyy] [name of copyright owner]

# CDDL HEADER END


# include SMF 
. /lib/svc/share/smf_include.sh

# our variables
typeset curlCA
typeset cert
typeset hashval
typeset subject


# generate a temporary new curlCA file
curlCA=$(mktemp)

cat >${curlCA} <<EOF
## OpenIndiana CA Root Certificate Bundle
##
## DO NOT EDIT THIS FILE - INSTEAD RUN svcadm refresh svc:/system/ca-certificates:default
##
## This is a bundled version of all root certificates in your OpenIndiana Installation.
## If you need to add new certificates, copy the cert in PEM format to /etc/certs/CA and
## run
##
## svcadm refresh svc:/system/ca-certificates:default
##
## This will create a new version of this file including all certificates
##
## this file was created at $(date +"%Y-%m-%d %H:%M:%S") local time.
##

EOF

cd /etc/certs/CA
for cert in *.pem; do
    hashval=$(openssl x509 -noout -hash -in ${cert})
    subject=$(openssl x509 -noout -subject -in ${cert})
    # update for openssl
    ( cd /etc/openssl/certs && ln -s ../../certs/CA/${cert} ${hashval}.0 2>/dev/null)
    printf "%s\n======================================================================\n" "${subject}" >>${curlCA}
    cat ${cert} >>${curlCA}
    echo >>${curlCA}
done

# now overwrite the real curlCA
cat ${curlCA} >/etc/curl/curlCA
