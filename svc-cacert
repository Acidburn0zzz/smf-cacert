#!/bin/ksh
# 2016-12-02 (c) Olaf Bohlen <olbohlen@eenfach.de>
# this is a SMF service method to update root certificate copies
# for curl, openssl, etc.

# include SMF 
. /lib/svc/share/smf_include.sh

# our veriables
typeset curlCA
typeset cert
typeset hashval
typeset subject


# generate a temporary new curlCA file
curlCA=$(mktemp)

cat >${curlCA} <<EOF
## OpenIndiana CA Root Certificate Bundle
##
## DO NOT EDIT THIS FILE - INSTEAD RUN svcadm refresh svc:/system/ca-certificates:default
##
## This is a bundled version of all root certificates in your OpenIndiana Installation.
## If you need to add new certificates, copy the cert in PEM format to /etc/certs/CA and
## run
##
## svcadm refresh svc:/system/ca-certificates:default
##
## This will create a new version of this file including all certificates
##
## this file was created at $(date +"%Y-%m-%d %H:%M:%S") local time.
##

EOF

cd /etc/certs/CA
for cert in *.pem; do
    hashval=$(openssl x509 -noout -hash -in ${cert})
    subject=$(openssl x509 -noout -subject -in ${cert})
    # update for openssl
    ( cd /etc/openssl/certs && ln -s ../../certs/CA/${cert} ${hashval}.0 2>/dev/null)
    printf "%s\n======================================================================\n" "${subject}" >>${curlCA}
    cat ${cert} >>${curlCA}
    echo >>${curlCA}
done

# now overwrite the real curlCA
cat ${curlCA} >/etc/curl/curlCA
